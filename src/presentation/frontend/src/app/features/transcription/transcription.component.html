<div class="transcription-container">
  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading && !activeTranscription">
    <div class="spinner"></div>
    <h3>Loading transcription...</h3>
  </div>

  <!-- Error State -->
  <div class="error-message" *ngIf="error && !activeTranscription">
    <span>‚ö†Ô∏è {{ error }}</span>
    <button class="btn btn-primary" (click)="goToUpload()">Go Back</button>
  </div>

  <!-- Transcription Detail -->
  <div class="transcription-detail" *ngIf="activeTranscription && !isLoading">
    <!-- Header -->
    <div class="header">
      <h1>Transcription Details</h1>
      <div class="header-actions">
        <button class="btn btn-secondary" (click)="goToUpload()">New Transcription</button>
        <button class="btn btn-secondary" (click)="goToHistory()">View History</button>
      </div>
    </div>

    <!-- Model Tabs (Show when multiple transcriptions exist) -->
    <div class="model-tabs" *ngIf="allTranscriptions.length > 1">
      <button
        *ngFor="let trans of allTranscriptions"
        class="tab-button"
        [class.active]="activeTranscription.id === trans.id"
        (click)="switchTranscription(trans)"
        [title]="'Switch to ' + (trans.model || 'unknown') + ' model transcription'"
      >
        <span class="tab-icon">ü§ñ</span>
        <span class="tab-label">{{ trans.model || 'unknown' }}</span>
        <span class="tab-status" [ngClass]="transcriptionService.getStatusClass(trans.status)"></span>
      </button>
    </div>

    <!-- Re-transcribe Button -->
    <div class="retranscribe-section" *ngIf="getModelsNotYetTranscribed().length > 0">
      <button class="btn btn-retranscribe" (click)="openRetranscribeDialog()">
        ‚ûï Transcribe with Different Model
      </button>
      <span class="retranscribe-hint">
        {{ getModelsNotYetTranscribed().length }} model(s) available
      </span>
    </div>

    <!-- Status Card -->
    <div class="status-card">
      <div class="status-header">
        <span class="status-badge" [ngClass]="transcriptionService.getStatusClass(activeTranscription.status)">
          {{ activeTranscription.status }}
        </span>
        <span class="timestamp">{{ formatDate(activeTranscription.created_at) }}</span>
      </div>

      <div class="metadata">
        <div class="metadata-item">
          <span class="label">ID:</span>
          <span class="value">{{ activeTranscription.id }}</span>
        </div>
        <div class="metadata-item" *ngIf="activeTranscription.language">
          <span class="label">Language:</span>
          <span class="value">{{ activeTranscription.language }}</span>
        </div>
        <div class="metadata-item" *ngIf="activeTranscription.model">
          <span class="label">Model:</span>
          <span class="value">{{ activeTranscription.model }}</span>
        </div>
        <div class="metadata-item">
          <span class="label">Duration:</span>
          <span class="value">{{ transcriptionService.formatDuration(activeTranscription.duration_seconds) }}</span>
        </div>
        <div class="metadata-item" *ngIf="activeTranscription.completed_at">
          <span class="label">Completed:</span>
          <span class="value">{{ formatDate(activeTranscription.completed_at) }}</span>
        </div>
      </div>
    </div>

    <!-- Processing State -->
    <div class="processing-state" *ngIf="activeTranscription.status === TranscriptionStatus.PROCESSING || activeTranscription.status === TranscriptionStatus.PENDING">
      <div class="spinner"></div>
      <h3>Transcription in progress...</h3>
      <p>Please wait while we process your audio. This page will update automatically.</p>
    </div>

    <!-- Error State -->
    <div class="error-state" *ngIf="activeTranscription.status === TranscriptionStatus.FAILED">
      <h3>‚ùå Transcription Failed</h3>
      <p class="error-text">{{ activeTranscription.error_message }}</p>
    </div>

    <!-- Completed State -->
    <div class="completed-state" *ngIf="activeTranscription.status === TranscriptionStatus.COMPLETED && activeTranscription.text">
      <div class="text-header">
        <h3>Transcription Result</h3>
        <div class="text-actions">
          <button
            class="btn btn-icon"
            (click)="isPlayingAudio ? stopAudio() : playAudio()"
            [title]="isPlayingAudio ? 'Stop audio' : 'Play original audio'"
          >
            {{ isPlayingAudio ? '‚èπÔ∏è' : '‚ñ∂Ô∏è' }} {{ isPlayingAudio ? 'Stop' : 'Play' }} Audio
          </button>
          <button class="btn btn-icon" (click)="copyToClipboard()" title="Copy to clipboard">
            üìã Copy
          </button>
          <button class="btn btn-icon" (click)="downloadText()" title="Download as text file">
            üíæ Download
          </button>
        </div>
      </div>

      <textarea
        class="transcription-text-editable"
        [(ngModel)]="activeTranscription.text"
        placeholder="Transcribed text will appear here..."
        rows="15"
      ></textarea>

      <div class="word-count">
        Word count: {{ activeTranscription.text ? activeTranscription.text.split(' ').length : 0 }} | Characters: {{ activeTranscription.text ? activeTranscription.text.length : 0 }}
      </div>
    </div>
  </div>

  <!-- Re-transcription Modal -->
  <div class="modal-overlay" *ngIf="showRetranscribeDialog" (click)="closeRetranscribeDialog()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Transcribe with Different Model</h2>
        <button class="modal-close" (click)="closeRetranscribeDialog()">‚úï</button>
      </div>

      <div class="modal-body">
        <p class="modal-description">
          Select a Whisper model to create a new transcription of this audio file.
          Each model offers different trade-offs between speed and accuracy.
        </p>

        <div class="form-group">
          <label for="model-select">Select Model:</label>
          <select
            id="model-select"
            class="model-select"
            [(ngModel)]="selectedModel"
            [disabled]="isRetranscribing"
          >
            <option *ngFor="let model of availableModels" [value]="model">
              {{ model }} {{ isModelAlreadyTranscribed(model) ? '(already transcribed)' : '' }}
            </option>
          </select>
        </div>

        <div class="model-info">
          <h4>Model Information:</h4>
          <ul>
            <li><strong>tiny:</strong> Fastest, least accurate (39M params)</li>
            <li><strong>base:</strong> Fast, good for most uses (74M params)</li>
            <li><strong>small:</strong> Balanced speed and accuracy (244M params)</li>
            <li><strong>medium:</strong> Better accuracy, slower (769M params)</li>
            <li><strong>large:</strong> Best accuracy, slowest (1550M params)</li>
          </ul>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeRetranscribeDialog()" [disabled]="isRetranscribing">
          Cancel
        </button>
        <button class="btn btn-primary" (click)="submitRetranscription()" [disabled]="isRetranscribing">
          {{ isRetranscribing ? 'Starting...' : 'Start Transcription' }}
        </button>
      </div>
    </div>
  </div>
</div>
