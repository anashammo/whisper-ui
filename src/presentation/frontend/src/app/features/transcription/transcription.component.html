<div class="transcription-container">
  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading && !activeTranscription">
    <div class="spinner"></div>
    <h3>Loading transcription...</h3>
  </div>

  <!-- Error State -->
  <div class="error-message" *ngIf="error && !activeTranscription">
    <span>‚ö†Ô∏è {{ error }}</span>
    <button class="btn btn-primary" (click)="goToUpload()">Go Back</button>
  </div>

  <!-- Transcription Detail -->
  <div class="transcription-detail" *ngIf="activeTranscription && !isLoading">
    <!-- Header -->
    <div class="header">
      <h1>Transcription Details</h1>
      <div class="header-actions">
        <button class="btn btn-secondary" (click)="goToUpload()">New Transcription</button>
        <button class="btn btn-secondary" (click)="goToHistory()">View History</button>
      </div>
    </div>

    <!-- Model Tabs (Show when multiple transcriptions exist) -->
    <div class="model-tabs" *ngIf="allTranscriptions && allTranscriptions.length > 1 && activeTranscription">
      <button
        *ngFor="let trans of allTranscriptions"
        class="tab-button"
        [class.active]="activeTranscription.id === trans.id"
        (click)="switchTranscription(trans)"
        [title]="'Switch to ' + (trans.model || 'unknown') + ' model transcription'"
      >
        <span class="tab-icon">ü§ñ</span>
        <span class="tab-label">{{ trans.model || 'unknown' }}</span>
        <span class="tab-status" [ngClass]="transcriptionService.getStatusClass(trans.status)"></span>
      </button>
    </div>

    <!-- Re-transcribe Button -->
    <div class="retranscribe-section" *ngIf="getModelsNotYetTranscribed().length > 0">
      <button class="btn btn-retranscribe" (click)="openRetranscribeDialog()">
        ‚ûï Transcribe with Different Model
      </button>
      <span class="retranscribe-hint">
        {{ getModelsNotYetTranscribed().length }} model(s) available
      </span>
    </div>

    <!-- Status Card -->
    <div class="status-card">
      <div class="status-header">
        <span class="status-badge" [ngClass]="transcriptionService.getStatusClass(activeTranscription.status)">
          {{ activeTranscription.status }}
        </span>
        <!-- LLM Enhancement Status Badge -->
        <span
          *ngIf="activeTranscription.enable_llm_enhancement"
          class="badge"
          [ngClass]="getLLMStatusBadgeClass()"
          [title]="'LLM Enhancement: ' + (activeTranscription.llm_enhancement_status || 'not started')">
          {{ getLLMStatusText() }}
        </span>
        <span class="timestamp">üìÖ {{ formatDate(activeTranscription.created_at) }}</span>
      </div>

      <div class="metadata">
        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #666;">Transcription Information</h4>
        <div class="metadata-item">
          <span class="label">Transcription ID:</span>
          <span class="value">{{ activeTranscription.id }}</span>
        </div>
        <div class="metadata-item" *ngIf="activeTranscription.language">
          <span class="label">Language:</span>
          <span class="value">{{ activeTranscription.language }}</span>
        </div>
        <div class="metadata-item" *ngIf="activeTranscription.model">
          <span class="label">Model:</span>
          <span class="value">{{ activeTranscription.model }}</span>
        </div>
        <div class="metadata-item" *ngIf="activeTranscription.processing_time_seconds !== null && activeTranscription.processing_time_seconds !== undefined">
          <span class="label">Processing Time:</span>
          <span class="value">{{ formatProcessingTime(activeTranscription.processing_time_seconds) }}</span>
        </div>
        <div class="metadata-item" *ngIf="activeTranscription.completed_at">
          <span class="label">Completed At:</span>
          <span class="value">{{ formatDate(activeTranscription.completed_at) }}</span>
        </div>
        <div class="metadata-item">
          <span class="label">Enhanced with LLM:</span>
          <span class="value">{{ activeTranscription.enable_llm_enhancement ? 'Yes' : 'No' }}</span>
        </div>
        <div class="metadata-item">
          <span class="label">VAD Filter Used:</span>
          <span class="value">{{ activeTranscription.vad_filter_used ? 'Yes' : 'No' }}</span>
        </div>
        <div class="metadata-item" *ngIf="activeTranscription.enable_llm_enhancement && activeTranscription.llm_enhancement_status">
          <span class="label">LLM Enhancement Status:</span>
          <span class="value">
            {{ activeTranscription.llm_enhancement_status }}
          </span>
        </div>
        <div class="metadata-item" *ngIf="activeTranscription.enable_llm_enhancement && activeTranscription.llm_processing_time_seconds !== null && activeTranscription.llm_processing_time_seconds !== undefined">
          <span class="label">LLM Processing Time:</span>
          <span class="value">{{ formatProcessingTime(activeTranscription.llm_processing_time_seconds) }}</span>
        </div>
        <div class="metadata-item" *ngIf="activeTranscription.enable_llm_enhancement && activeTranscription.llm_error_message">
          <span class="label">LLM Error:</span>
          <span class="value error-text">{{ activeTranscription.llm_error_message }}</span>
        </div>
      </div>

      <div class="metadata" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0;">
        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #666;">Audio File Information</h4>
        <div class="metadata-item">
          <span class="label">Audio File ID:</span>
          <span class="value">{{ activeTranscription.audio_file_id }}</span>
        </div>
        <div class="metadata-item" *ngIf="activeTranscription.audio_file_original_filename">
          <span class="label">Original Filename:</span>
          <span class="value">{{ activeTranscription.audio_file_original_filename }}</span>
        </div>
        <div class="metadata-item">
          <span class="label">Duration:</span>
          <span class="value">{{ transcriptionService.formatDuration(activeTranscription.duration_seconds) }}</span>
        </div>
        <div class="metadata-item" *ngIf="activeTranscription.audio_file_uploaded_at">
          <span class="label">Created At:</span>
          <span class="value">{{ formatDate(activeTranscription.audio_file_uploaded_at) }}</span>
        </div>
      </div>
    </div>

    <!-- Processing State -->
    <div class="processing-state" *ngIf="activeTranscription.status === TranscriptionStatus.PROCESSING || activeTranscription.status === TranscriptionStatus.PENDING">
      <div class="spinner"></div>
      <h3>Transcription in progress...</h3>
      <p>Please wait while we process your audio. This page will update automatically.</p>
    </div>

    <!-- Error State -->
    <div class="error-state" *ngIf="activeTranscription.status === TranscriptionStatus.FAILED">
      <h3>‚ùå Transcription Failed</h3>
      <p class="error-text">{{ activeTranscription.error_message }}</p>
    </div>

    <!-- Completed State -->
    <div class="completed-state" *ngIf="activeTranscription.status === TranscriptionStatus.COMPLETED && activeTranscription.text">
      <div class="text-header">
        <h3>Transcription Result</h3>
        <div class="text-actions">
          <button
            class="btn btn-icon"
            (click)="isPlayingAudio ? stopAudio() : playAudio()"
            [title]="isPlayingAudio ? 'Stop audio' : 'Play original audio'"
          >
            {{ isPlayingAudio ? '‚èπÔ∏è Stop' : '‚ñ∂Ô∏è Play' }}
          </button>
          <button
            class="btn btn-icon"
            (click)="downloadAudio()"
            title="Download original audio file"
          >
            ‚¨áÔ∏è Download
          </button>
          <button class="btn btn-icon" (click)="copyToClipboard()" title="Copy original transcription to clipboard">
            üìã Copy Original
          </button>
          <button
            *ngIf="activeTranscription.enable_llm_enhancement && activeTranscription.enhanced_text && !activeTranscription.llm_error_message"
            class="btn btn-icon"
            (click)="copyEnhancedToClipboard()"
            title="Copy enhanced transcription to clipboard"
          >
            üìã Copy Enhanced
          </button>
          <button
            *ngIf="canEnhance()"
            class="btn btn-icon btn-enhance"
            (click)="enhanceTranscription()"
            [disabled]="isEnhancing"
            title="Enhance transcription with LLM"
          >
            ‚ú® {{ isEnhancing ? 'Enhancing...' : 'Enhance with LLM' }}
          </button>
        </div>
      </div>

      <!-- Dual Text Areas: Show both if LLM enhancement is enabled -->
      <div class="text-areas-container" *ngIf="activeTranscription.enable_llm_enhancement; else singleTextArea">
        <div class="text-area-section">
          <h4 class="text-area-title">Original Whisper Transcription</h4>
          <textarea
            class="transcription-text-editable"
            [value]="activeTranscription.text || ''"
            placeholder="Transcribed text will appear here..."
            rows="15"
            readonly
          ></textarea>
          <div class="word-count">
            Word count: {{ activeTranscription.text ? activeTranscription.text.split(' ').length : 0 }} | Characters: {{ activeTranscription.text ? activeTranscription.text.length : 0 }}
          </div>
        </div>

        <div class="text-area-section">
          <h4 class="text-area-title">Enhanced with LLM</h4>
          <textarea
            class="transcription-text-editable"
            [value]="activeTranscription.enhanced_text || ''"
            placeholder="Enhanced text will appear here after LLM processing..."
            rows="15"
            readonly
          ></textarea>
          <div class="word-count" *ngIf="activeTranscription.enhanced_text">
            Word count: {{ activeTranscription.enhanced_text.split(' ').length }} | Characters: {{ activeTranscription.enhanced_text.length }}
          </div>
          <div class="llm-processing-indicator" *ngIf="activeTranscription.llm_enhancement_status === 'processing' || isEnhancing">
            <div class="spinner-small"></div>
            <span>Processing with LLM...</span>
          </div>
        </div>
      </div>

      <!-- Single Text Area Template (when LLM not enabled) -->
      <ng-template #singleTextArea>
        <textarea
          class="transcription-text-editable"
          [value]="activeTranscription.text || ''"
          placeholder="Transcribed text will appear here..."
          rows="15"
          readonly
        ></textarea>
        <div class="word-count">
          Word count: {{ activeTranscription.text ? activeTranscription.text.split(' ').length : 0 }} | Characters: {{ activeTranscription.text ? activeTranscription.text.length : 0 }}
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Re-transcription Modal -->
  <div class="modal-overlay" *ngIf="showRetranscribeDialog" (click)="closeRetranscribeDialog()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Transcribe with Different Model</h2>
        <button class="modal-close" (click)="closeRetranscribeDialog()">‚úï</button>
      </div>

      <div class="modal-body">
        <p class="modal-description">
          Select a Whisper model to create a new transcription of this audio file.
          Each model offers different trade-offs between speed and accuracy.
        </p>

        <div class="form-group">
          <label for="model-select">Select Model:</label>
          <select
            id="model-select"
            class="model-select"
            [(ngModel)]="selectedModel"
            (ngModelChange)="onModelChange()"
            [disabled]="isRetranscribing || isDownloadingModel"
          >
            <option *ngFor="let model of getModelsNotYetTranscribed()" [value]="model">
              {{ model }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="language-select">Language:</label>
          <select
            id="language-select"
            class="model-select"
            [(ngModel)]="selectedLanguage"
            [disabled]="isRetranscribing || isDownloadingModel"
          >
            <option *ngFor="let lang of languages" [value]="lang.code">
              {{ lang.name }}
            </option>
          </select>
        </div>

        <!-- Download Progress Bar -->
        <div class="download-progress" *ngIf="isDownloadingModel">
          <div class="progress-label">Downloading model {{ selectedModel }}...</div>
          <div class="progress-bar-container">
            <div class="progress-bar-fill" [style.width.%]="downloadProgress"></div>
          </div>
          <div class="progress-text">{{ downloadProgress.toFixed(1) }}%</div>
        </div>

        <div class="model-info" *ngIf="getSelectedModelInfo() as info">
          <h4>Selected Model: {{ info.name }}</h4>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Speed:</span>
              <span class="info-value">{{ info.speed }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Parameters:</span>
              <span class="info-value">{{ info.params }}</span>
            </div>
          </div>
          <p class="info-description">{{ info.description }}</p>
        </div>

        <!-- LLM Enhancement Checkbox -->
        <div class="llm-enhancement-option">
          <label>
            <input type="checkbox" [(ngModel)]="enableLlmEnhancement" />
            Enhance with LLM (grammar, formatting, filler removal)
          </label>
        </div>

        <!-- Arabic Tashkeel Checkbox (only visible when LLM enabled) -->
        <div class="llm-enhancement-option tashkeel-option" *ngIf="enableLlmEnhancement">
          <label>
            <input type="checkbox" [(ngModel)]="enableTashkeel" />
            Add Arabic Tashkeel (diacritics/vocalization for Arabic text)
          </label>
        </div>

        <!-- VAD Filter Checkbox -->
        <div class="llm-enhancement-option">
          <label>
            <input type="checkbox" [(ngModel)]="enableVadFilter" />
            Enable VAD (Voice Activity Detection - filters silence, improves accuracy)
          </label>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeRetranscribeDialog()" [disabled]="isRetranscribing || isDownloadingModel">
          Cancel
        </button>
        <button class="btn btn-primary" (click)="submitRetranscription()" [disabled]="isRetranscribing || isDownloadingModel">
          {{ isDownloadingModel ? 'Downloading...' : (isRetranscribing ? 'Starting...' : 'Start Transcription') }}
        </button>
      </div>
    </div>
  </div>
</div>
