<div class="history-container">
  <!-- Header -->
  <div class="header">
    <h1>Transcription History</h1>
    <button class="btn btn-primary" (click)="goToUpload()">New Transcription</button>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading && audioFilesWithTranscriptions.length === 0">
    <div class="spinner"></div>
    <h3>Loading history...</h3>
  </div>

  <!-- Error State -->
  <div class="error-message" *ngIf="error">
    <span>âš ï¸ {{ error }}</span>
    <button class="btn btn-primary" (click)="loadHistory()">Retry</button>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!isLoading && audioFilesWithTranscriptions.length === 0 && !error">
    <div class="empty-icon">ğŸ“</div>
    <h3>No transcriptions yet</h3>
    <p>Click "New Transcription" above to get started!</p>
  </div>

  <!-- Grouped Audio File List -->
  <div class="audio-file-list" *ngIf="audioFilesWithTranscriptions.length > 0">
    <div
      *ngFor="let audioFileGroup of audioFilesWithTranscriptions"
      class="audio-file-card"
    >
      <!-- Audio File Header (Clickable to Expand/Collapse) -->
      <div class="audio-file-header">
        <div class="audio-file-info" (click)="toggleExpanded(audioFileGroup.audio_file.id)">
          <h3 class="audio-filename">{{ audioFileGroup.audio_file.original_filename }}</h3>
          <div class="audio-file-id">ID: {{ audioFileGroup.audio_file.id }}</div>
          <div class="audio-metadata">
            <span class="metadata-badge">
              ğŸ“Š {{ audioFileGroup.transcription_count }} transcription(s)
            </span>
            <span class="metadata-badge" *ngIf="audioFileGroup.audio_file.duration_seconds">
              â±ï¸ {{ transcriptionService.formatDuration(audioFileGroup.audio_file.duration_seconds) }}
            </span>
            <span class="metadata-badge">
              ğŸ“… {{ formatDate(audioFileGroup.audio_file.uploaded_at) }}
            </span>
          </div>
        </div>
        <div class="header-actions">
          <!-- Audio Controls -->
          <button
            class="btn-play-header"
            (click)="playAudioFile($event, audioFileGroup.audio_file.id)"
            [title]="isAudioFilePlaying(audioFileGroup.audio_file.id) ? 'Stop audio' : 'Play audio'">
            {{ isAudioFilePlaying(audioFileGroup.audio_file.id) ? 'â¹ï¸' : 'â–¶ï¸' }}
          </button>
          <button
            class="btn-download-header"
            (click)="downloadAudioFile($event, audioFileGroup.audio_file.id)"
            title="Download audio file">
            â¬‡ï¸
          </button>
          <button
            class="btn-delete-audio"
            (click)="deleteAudioFile(audioFileGroup.audio_file.id, audioFileGroup.transcription_count, $event)"
            title="Delete audio file and all transcriptions">
            ğŸ—‘ï¸
          </button>
        </div>
      </div>

      <!-- Expandable Transcriptions Section -->
      <div class="transcriptions-container" *ngIf="isExpanded(audioFileGroup.audio_file.id)">
        <div class="transcriptions-grid">
          <div
            *ngFor="let transcription of audioFileGroup.transcriptions"
            class="transcription-item"
            (click)="viewTranscription(transcription.id)"
          >
            <!-- Model Badge -->
            <div class="transcription-item-header">
              <span class="model-badge">ğŸ¤– {{ transcription.model || 'unknown' }}</span>
              <span class="status-badge" [ngClass]="transcriptionService.getStatusClass(transcription.status)">
                {{ transcription.status }}
              </span>
              <!-- LLM Enhancement Status Badge -->
              <span
                *ngIf="transcription.enable_llm_enhancement"
                class="badge"
                [ngClass]="getLLMStatusBadgeClass(transcription)"
                [title]="'LLM Enhancement: ' + (transcription.llm_enhancement_status || 'not started')">
                {{ getLLMStatusText(transcription) }}
              </span>
            </div>

            <!-- Text Preview -->
            <div class="transcription-text-preview">
              <div class="text-label">Original:</div>
              <div class="text-content">
                {{ getTruncatedText(transcription.text, 80) }}
              </div>
            </div>

            <!-- Enhanced Text Preview (only if exists) -->
            <div
              class="transcription-text-preview enhanced-text-preview"
              *ngIf="transcription.enhanced_text">
              <div class="text-label enhanced-label">âœ¨ Enhanced:</div>
              <div class="text-content">
                {{ getTruncatedText(transcription.enhanced_text, 80) }}
              </div>
            </div>

            <!-- Metadata -->
            <div class="transcription-item-metadata">
              <span class="meta-item" *ngIf="transcription.language">
                ğŸŒ {{ transcription.language }}
              </span>
              <span class="meta-item">
                ğŸ“… {{ formatDate(transcription.created_at) }}
              </span>
            </div>

            <!-- Actions -->
            <div class="transcription-item-actions">
              <button
                class="btn-icon btn-delete-small"
                (click)="deleteTranscription($event, transcription.id)"
                title="Delete transcription"
              >
                ğŸ—‘ï¸
              </button>
              <span class="view-link-small">View â†’</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Info -->
  <div class="results-info" *ngIf="audioFilesWithTranscriptions.length > 0">
    Showing {{ audioFilesWithTranscriptions.length }} audio file(s)
  </div>
</div>
